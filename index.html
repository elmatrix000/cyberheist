<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CyberHeist</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<script src="https://cdn.jsdelivr.net/npm/phaser@3.80.0/dist/phaser.min.js"></script>

<style>
html,body{margin:0;padding:0;background:#040808;overflow:hidden}
canvas{display:block;margin:0 auto;touch-action:none}
#overlay{
  position:fixed;inset:0;
  display:flex;align-items:center;justify-content:center;
  font-family:monospace;
  color:#00ffd0;
  background:#040808;
  z-index:10;
}
#ui{
  position:fixed;top:8px;left:8px;
  font-family:monospace;
  color:#00ffd0;
  z-index:5;
}
</style>
</head>

<body>
<div id="overlay">TOUCH TO START</div>
<div id="ui"></div>

<script>
/* ================= CONFIG ================= */
const W=360,H=640;
let player, bullets, enemyBullets, enemies, pickups;
let moveDir=0, canShoot=true;
let health=100, shield=0, score=0;
let invuln=false, gameOver=false;
let spawnTimer=0, difficulty=1;

const overlay=document.getElementById("overlay");
const ui=document.getElementById("ui");

/* ================= GAME ================= */
new Phaser.Game({
  type:Phaser.AUTO,
  width:W,height:H,
  physics:{default:'arcade',arcade:{gravity:{y:0}}},
  scale:{mode:Phaser.Scale.FIT,autoCenter:Phaser.Scale.CENTER_BOTH},
  scene:{preload,create,update}
});

/* ================= PRELOAD ================= */
function preload(){
  this.load.image('player','player.PNG');
  this.load.image('enemy','enemy.PNG');
  this.load.image('bullet','bullet.PNG');
  this.load.image('data','data.PNG');
  this.load.image('power','power.PNG');

  overlay.addEventListener("pointerdown",()=>{
    overlay.style.display="none";
  },{once:true});
}

/* ================= CREATE ================= */
function create(){
  this.bg=this.add.rectangle(0,0,W,H,0x020a0a).setOrigin(0);

  player=this.physics.add.sprite(W/2,H-100,'player')
    .setScale(0.25)
    .setCollideWorldBounds(true);

  bullets=this.physics.add.group();
  enemyBullets=this.physics.add.group();
  enemies=this.physics.add.group();
  pickups=this.physics.add.group();

  // Controls
  const style={fontSize:'20px',backgroundColor:'#111',color:'#00ffd0',padding:{x:14,y:6}};
  this.add.text(20,H-60,'◀',style).setInteractive()
    .on('pointerdown',()=>moveDir=-1)
    .on('pointerup',()=>moveDir=0);
  this.add.text(90,H-60,'▶',style).setInteractive()
    .on('pointerdown',()=>moveDir=1)
    .on('pointerup',()=>moveDir=0);
  this.add.text(W-70,H-60,'⦿',style).setInteractive()
    .on('pointerdown',()=>shoot(this));

  // Collisions
  this.physics.add.overlap(bullets,enemies,enemyHit,null,this);
  this.physics.add.overlap(enemyBullets,player,playerHit,null,this);
  this.physics.add.overlap(player,pickups,pickup,null,this);
}

/* ================= UPDATE ================= */
function update(time){
  if(gameOver)return;

  // Player motion
  player.setVelocityX(moveDir*260);
  player.y = H-100 + Math.sin(time*0.004)*3;

  // Spawn enemies over time
  spawnTimer+=1;
  if(spawnTimer>80-(difficulty*5)){
    spawnTimer=0;
    spawnEnemy(this);
  }

  // Enemy behavior
  enemies.children.each(e=>{
    if(!e)return;
    e.y+=1.2+difficulty*0.2;
    e.x+=Math.sin(time*0.003+e.y)*0.6;
    if(Phaser.Math.Between(0,140-difficulty*10)==0)
      enemyShoot(this,e);
    if(e.y>H+40)e.destroy();
  });

  // Cleanup bullets
  bullets.children.each(b=>{
    if(b && b.y<-20)b.destroy();
  });
  enemyBullets.children.each(b=>{
    if(b && b.y>H+20)b.destroy();
  });

  ui.innerText=
    `SIGNAL ${health}\n`+
    `SHIELD ${shield}\n`+
    `SCORE ${score}`;
}

/* ================= ACTIONS ================= */
function shoot(scene){
  if(!canShoot||gameOver)return;

  const b=scene.physics.add.sprite(player.x,player.y-26,'bullet')
    .setScale(0.15)
    .setVelocityY(-520)
    .setAngle(-90);

  bullets.add(b);
  canShoot=false;
  scene.time.delayedCall(200,()=>canShoot=true);
}

function enemyShoot(scene,e){
  const b=scene.physics.add.sprite(e.x,e.y+20,'bullet')
    .setScale(0.12)
    .setVelocityY(260)
    .setAngle(90);
  enemyBullets.add(b);
}

function spawnEnemy(scene){
  enemies.add(
    scene.physics.add.sprite(
      Phaser.Math.Between(40,W-40),
      -40,'enemy'
    ).setScale(0.22)
  );
}

function enemyHit(b,e){
  b.destroy();
  e.destroy();
  score+=10;
  if(score%100===0) difficulty++;

  if(Phaser.Math.Between(0,3)==0)
    pickups.add(this.physics.add.sprite(e.x,e.y,'data').setScale(0.15));
}

function pickup(player,p){
  p.destroy();
  if(p.texture.key==='data')score+=25;
  if(p.texture.key==='power')shield=50;
}

function playerHit(player,b){
  if(invuln)return;
  b.destroy();

  invuln=true;
  player.setTint(0xff3333);

  if(shield>0)shield-=20;
  else health-=20;

  this.time.delayedCall(400,()=>{
    invuln=false;
    player.clearTint();
  });

  if(health<=0) endGame(this);
}

/* ================= END ================= */
function endGame(scene){
  gameOver=true;
  scene.add.rectangle(0,0,W,H,0x000000,0.9).setOrigin(0);
  scene.add.text(W/2,H/2,
    "SYSTEM OVERRUN\nFINAL SCORE "+score,
    {fontSize:'18px',color:'#ff3355',align:'center'}
  ).setOrigin(0.5);
}
</script>
</body>
</html>
