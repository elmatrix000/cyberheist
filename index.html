<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CYBERHEIST</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<script src="https://cdn.jsdelivr.net/npm/phaser@3.80.0/dist/phaser.min.js"></script>

<style>
html,body{margin:0;padding:0;background:#020606;overflow:hidden}
canvas{display:block;margin:0 auto;touch-action:none}
#overlay{
  position:fixed;inset:0;
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  font-family:monospace;
  color:#00ffd0;
  background:#020606;
  z-index:10;
  text-align:center;
}
#ui{
  position:fixed;top:8px;left:8px;
  font-family:monospace;font-size:12px;
  color:#00ffd0;z-index:5;
}
.story{
  position:fixed;bottom:120px;width:100%;
  text-align:center;font-family:monospace;
  color:#00ffd0;opacity:0.85;
}
</style>
</head>

<body>
<div id="overlay">
  <h2>CYBERHEIST</h2>
  <p>Kagiso → System Core</p>
  <p>TOUCH TO JACK IN</p>
</div>
<div id="ui"></div>
<div class="story" id="story"></div>

<script>
/* ================= CONFIG ================= */
const W=360,H=640;
let player, pBullets, eBullets, enemies, bossGroup, pickups;
let move=0, canShoot=true, charging=false;
let signal=100, shield=0, score=0;
let invuln=false, state='PLAY';
let spawnTick=0, difficulty=1;
let bossHP=0, bossPhase=1;
const ui=document.getElementById("ui");
const story=document.getElementById("story");
document.getElementById("overlay").onclick=()=>overlay.style.display="none";

/* ================= GAME ================= */
new Phaser.Game({
  type:Phaser.AUTO,
  width:W,height:H,
  physics:{default:'arcade',arcade:{gravity:{y:0}}},
  scale:{mode:Phaser.Scale.FIT,autoCenter:Phaser.Scale.CENTER_BOTH},
  scene:{preload,create,update}
});

/* ================= PRELOAD ================= */
function preload(){
  ['player','enemy','boss','bullet','data','power']
  .forEach(k=>this.load.image(k,`${k}.PNG`));
}

/* ================= CREATE ================= */
function create(){
  this.add.rectangle(0,0,W,H,0x020a0a).setOrigin(0);

  player=this.physics.add.sprite(W/2,H-90,'player')
    .setScale(0.25).setCollideWorldBounds(true);

  pBullets=this.physics.add.group();
  eBullets=this.physics.add.group();
  enemies=this.physics.add.group();
  bossGroup=this.physics.add.group();
  pickups=this.physics.add.group();

  // Touch UI
  const s={fontSize:'20px',backgroundColor:'#111',color:'#00ffd0',padding:{x:14,y:6}};
  this.add.text(20,H-60,'◀',s).setInteractive()
    .on('pointerdown',()=>move=-1)
    .on('pointerup',()=>move=0);
  this.add.text(90,H-60,'▶',s).setInteractive()
    .on('pointerdown',()=>move=1)
    .on('pointerup',()=>move=0);
  this.add.text(W-70,H-60,'⦿',s).setInteractive()
    .on('pointerdown',()=>charging=true)
    .on('pointerup',()=>{fire(this);charging=false});

  // Collisions
  this.physics.add.overlap(pBullets,enemies,hitEnemy,null,this);
  this.physics.add.overlap(pBullets,bossGroup,hitBoss,null,this);
  this.physics.add.overlap(eBullets,player,hitPlayer,null,this);
  this.physics.add.overlap(player,pickups,collect,null,this);

  storyText("KAGISO SIGNAL DETECTED… ESCAPE THE GRID");
}

/* ================= UPDATE ================= */
function update(time){
  if(state==='GAMEOVER')return;

  player.setVelocityX(move*260);
  player.y=H-90+Math.sin(time*0.004)*3;

  if(state==='PLAY'){
    spawnTick++;
    if(spawnTick>90-(difficulty*8)){
      spawnTick=0;
      spawnEnemy(this);
    }
    if(score>=500) spawnBoss(this);
  }

  enemies.children.each(e=>{
    if(!e)return;
    e.y+=1.2+difficulty*0.2;
    e.x+=Math.sin(time*0.003+e.y)*0.6;
    if(Phaser.Math.Between(0,120)==0) enemyShoot(this,e);
    if(e.y>H+40)e.destroy();
  });

  bossGroup.children.each(b=>{
    b.x=W/2+Math.sin(time*0.002)*80;
    if(time%(bossPhase===1?90:45)<2) bossShoot(this,b);
  });

  cleanup();

  ui.innerText=
    `SIGNAL ${signal}\nSHIELD ${shield}\nDATA ${score}`+
    (state==='BOSS'?`\nCORE ${bossHP}`:'');
}

/* ================= ACTIONS ================= */
function fire(scene){
  if(!canShoot)return;
  const power=charging?2:1;
  const b=scene.physics.add.sprite(player.x,player.y-30,'bullet')
    .setScale(0.15*power)
    .setVelocityY(-520*power)
    .setAngle(-90);
  b.damage=10*power;
  pBullets.add(b);
  canShoot=false;
  scene.time.delayedCall(charging?400:200,()=>canShoot=true);
}

function enemyShoot(scene,e){
  const b=scene.physics.add.sprite(e.x,e.y+18,'bullet')
    .setScale(0.12).setVelocityY(260).setAngle(90);
  eBullets.add(b);
}

function spawnEnemy(scene){
  const e=scene.physics.add.sprite(
    Phaser.Math.Between(40,W-40),-40,'enemy'
  ).setScale(0.22);
  enemies.add(e);
}

/* ================= BOSS ================= */
function spawnBoss(scene){
  state='BOSS';
  enemies.clear(true,true);
  storyText("CORPORATE CORE ONLINE");

  const b=scene.physics.add.sprite(W/2,-150,'boss').setScale(0.35);
  bossGroup.add(b);
  bossHP=600; bossPhase=1;

  scene.tweens.add({targets:b,y:140,duration:1500,ease:'Sine.easeOut'});
}

function hitBoss(bullet,boss){
  bullet.destroy();
  bossHP-=bullet.damage;
  boss.setTint(0xff4444);
  scene.cameras.main.shake(80,0.01);
  setTimeout(()=>boss.clearTint(),80);

  if(bossHP<300) bossPhase=2;
  if(bossHP<=0){
    boss.destroy();
    bossGroup.clear(true,true);
    state='PLAY';
    score+=500;
    difficulty++;
    storyText("CORE BREACHED. MOVE.");
  }
}

function bossShoot(scene,b){
  for(let i=-1;i<=1;i++){
    const s=scene.physics.add.sprite(b.x+i*30,b.y+40,'bullet')
      .setScale(0.18).setVelocity(i*80,300).setAngle(90);
    eBullets.add(s);
  }
}

/* ================= COLLISIONS ================= */
function hitEnemy(b,e){
  b.destroy(); e.destroy(); score+=10;
  if(Phaser.Math.Between(0,4)==0)
    pickups.add(this.physics.add.sprite(e.x,e.y,'data').setScale(0.15));
}

function collect(p,c){
  c.destroy();
  if(c.texture.key==='data')score+=25;
  if(c.texture.key==='power')shield=50;
}

function hitPlayer(p,b){
  if(invuln)return;
  b.destroy();
  invuln=true;
  p.setTint(0xff3333);
  shield>0?shield-=20:signal-=20;
  setTimeout(()=>{invuln=false;p.clearTint()},400);
  if(signal<=0) endGame(this);
}

/* ================= UTILS ================= */
function cleanup(){
  pBullets.children.each(b=>{if(b&&b.y<-20)b.destroy()});
  eBullets.children.each(b=>{if(b&&b.y>H+20)b.destroy()});
}

function storyText(t){
  story.innerText=t;
  setTimeout(()=>story.innerText='',3000);
}

function endGame(scene){
  state='GAMEOVER';
  scene.add.rectangle(0,0,W,H,0x000000,0.9).setOrigin(0);
  scene.add.text(W/2,H/2,
    "SIGNAL LOST\nDATA "+score,
    {fontSize:'18px',color:'#ff3355',align:'center'}
  ).setOrigin(0.5);
}
</script>
</body>
</html>
