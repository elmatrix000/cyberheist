<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GothAlienBoy — Cyber Heist</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.min.js"></script>
<style>
html, body { margin:0; padding:0; background:#010707; overflow:hidden; }
#game { width:100vw; height:100vh; }
canvas { width:100% !important; height:100% !important; touch-action:none; }
</style>
</head>
<body>
<div id="game"></div>

<script>
const W = 360, H = 640;

const config = {
    type: Phaser.AUTO,
    width: W,
    height: H,
    parent: 'game',
    physics: { default: 'arcade', arcade: { gravity: {y:0} } },
    scale: { mode: Phaser.Scale.FIT, autoCenter: Phaser.Scale.CENTER_BOTH },
    scene: { preload, create, update }
};

new Phaser.Game(config);

let player, bullets, enemies, enemyBullets, boss, drones, powerups;
let move=0, velocity=0, canShoot=true;
let signal=150, score=0, phase=1;
let gameOver=false;

/* ================= PRELOAD ================= */
function preload(){
    this.load.image('player','player.PNG');
    this.load.image('enemy','enemy.PNG');
    this.load.image('boss','boss.PNG');
    this.load.image('drone','drone.PNG');
    this.load.image('data','data.PNG');
    this.load.image('power','power.PNG');
    this.load.image('bullet','bullet.PNG');
}

/* ================= CREATE ================= */
function create(){
    this.add.rectangle(0,0,W,H,0x101820).setOrigin(0);

    player = this.physics.add.sprite(W/2,H-90,'player').setTint(0x00ffcc);
    player.setCollideWorldBounds(true);

    bullets = this.physics.add.group();
    enemyBullets = this.physics.add.group();
    enemies = this.physics.add.group();
    drones = this.physics.add.group();
    powerups = this.physics.add.group();

    spawnWave(this);

    this.signalText = this.add.text(10,10,'SIGNAL: 150',{fontSize:'14px',color:'#00ffd0'});
    this.phaseText = this.add.text(10,28,'PHASE: 1',{fontSize:'12px',color:'#00ffd0'});
    this.scoreText = this.add.text(10,46,'SCORE: 0',{fontSize:'12px',color:'#00ffd0'});

    const style={fontSize:'24px',backgroundColor:'#111',color:'#00ffd0',padding:{x:14,y:6}};
    const L=this.add.text(20,H-60,'◀',style).setInteractive();
    const R=this.add.text(80,H-60,'▶',style).setInteractive();
    const F=this.add.text(W-70,H-60,'⦿',style).setInteractive();

    L.on('pointerdown',()=>move=-1); L.on('pointerup',()=>move=0); L.on('pointerout',()=>move=0);
    R.on('pointerdown',()=>move=1); R.on('pointerup',()=>move=0); R.on('pointerout',()=>move=0);
    F.on('pointerdown',()=>shoot(this));

    this.physics.add.overlap(bullets,enemies,hitEnemy,null,this);
    this.physics.add.overlap(bullets,drones,hitDrone,null,this);
    this.physics.add.overlap(bullets,boss,hitBoss,null,this);
    this.physics.add.overlap(enemyBullets,player,hitPlayer,null,this);
    this.physics.add.overlap(player,powerups,collectPower,null,this);

    showStory(this,"PHASE 1: SIGNAL RUN");
}

/* ================= UPDATE ================= */
function update(time, delta){
    if(gameOver) return;

    velocity += move*1.4;
    velocity *= 0.88;
    player.setVelocityX(velocity*30);

    enemies.children.each(e=>{
        if(!e) return;
        e.y += 0.5 + phase*0.2;
        e.x += Math.sin(this.time.now*0.002 + (e.phase||0))*2;
        e.setTint(0xff3300);
        if(Phaser.Math.Between(0,200)===1) fireEnemy(this,e);
        if(e.y>H+20) e.destroy();
    });

    drones.children.each(d=>{
        d.y += 0.3;
        d.x += Math.sin(this.time.now*0.004 + (d.phase||0))*5;
        d.setTint(0xff00ff);
        if(Phaser.Math.Between(0,300)===1) fireEnemy(this,d);
        if(d.y>H+20) d.destroy();
    });

    enemyBullets.children.each(b=>{
        if(b.y>H+20) b.destroy();
    });
    bullets.children.each(b=>{
        if(b.y<-20) b.destroy();
    });

    if(boss){
        boss.y += 0.3;
        boss.x = W/2 + Math.sin(this.time.now*0.002)*80;
        boss.setTint(0xffaa00);
        if(Phaser.Math.Between(0,50)===1){
            fireEnemy(this,boss);
            fireEnemy(this,boss);
        }
    }

    if(Math.random()<0.001*phase){
        const p = this.physics.add.sprite(Phaser.Math.Between(30,W-30),-20,Math.random()<0.5?'data':'power');
        p.body.setVelocityY(50);
        powerups.add(p);
        p.setTint(0x00ffff);
    }

    // --- TIME-BASED SIGNAL DRAIN ---
    signal -= (0.02 * phase) * (delta / 16.666); 
    if(signal <= 0) end(this,false);

    this.signalText.setText("SIGNAL: "+Math.floor(signal));
    this.phaseText.setText("PHASE: "+phase);
    this.scoreText.setText("SCORE: "+score);
}

/* ================= GAMEPLAY ================= */
function spawnWave(scene){
    for(let i=0;i<4+phase;i++){
        const e = scene.physics.add.sprite(40+i*60,-60,'enemy');
        e.speed = 0.5+phase*0.2;
        e.phase = Math.random()*6;
        enemies.add(e);
    }

    for(let i=0;i<phase;i++){
        const d = scene.physics.add.sprite(Phaser.Math.Between(30,W-30),-100,'drone');
        d.phase = Math.random()*6;
        drones.add(d);
    }

    if(phase>=3 && !boss){
        boss = scene.physics.add.sprite(W/2,-120,'boss');
        boss.hp = 40;
        showStory(scene,"CORE NODE ONLINE");
    }
}

function shoot(scene){
    if(!canShoot||gameOver) return;
    const b = scene.physics.add.sprite(player.x,player.y-20,'bullet');
    b.setVelocityY(-400);
    b.setTint(0x00ffff);
    bullets.add(b);

    bullets.children.each(bb=>{
        if(bb.multi) bb.setVelocityX(-30);
        if(bb.multi2) bb.setVelocityX(30);
    });

    canShoot=false;
    scene.time.delayedCall(200,()=>canShoot=true);
}

function fireEnemy(scene,e){
    const b = scene.physics.add.sprite(e.x,e.y+20,'bullet');
    b.setVelocityY(200+phase*20);
    b.setTint(0xff3300);
    enemyBullets.add(b);
}

function hitEnemy(b,e){
    b.destroy(); e.destroy();
    score+=10; signal+=3;
}

function hitDrone(b,d){
    b.destroy(); d.destroy();
    score+=15; signal+=5;
}

function hitBoss(b){
    b.destroy();
    boss.hp--;
    if(boss.hp<=0){
        boss.destroy(); boss=null;
        score+=200; signal+=20;
        phase++; spawnWave(this);
        showStory(this,"CORE NODE DESTROYED");
    }
}

function hitPlayer(){
    signal -= 15;
    if(signal <= 0) end(this,false);
}

function collectPower(p,player){
    p.destroy();
    if(p.texture.key==='data') signal+=15;
    else if(p.texture.key==='power'){
        bullets.children.each(bb=>{
            bb.multi=true; bb.multi2=true;
        });
        setTimeout(()=>bullets.children.each(bb=>{
            bb.multi=false; bb.multi2=false;
        }),5000);
    }
}

function showStory(scene,text){
    const box = scene.add.rectangle(0,0,W,H,0x000000,0.7).setOrigin(0);
    const t = scene.add.text(W/2,H/2,text,{fontSize:'16px',align:'center',color:'#00ffd0'}).setOrigin(0.5);
    scene.time.delayedCall(1800,()=>{box.destroy(); t.destroy();});
}

function end(scene,win){
    gameOver=true;
    scene.add.rectangle(0,0,W,H,0x000000,0.9).setOrigin(0);
    scene.add.text(W/2,H/2,
        win?"GRID DESTROYED!":"GAME OVER",
        {fontSize:'20px',align:'center',color:win?'#00ffd0':'#ff3355'}
    ).setOrigin(0.5);
}
</script>
</body>
</html>
