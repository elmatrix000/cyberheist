<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CyberHeist</title>

<meta name="viewport"
content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<script src="https://cdn.jsdelivr.net/npm/phaser@3.80.0/dist/phaser.min.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: #050808;
  overflow: hidden;
}
#status {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: monospace;
  color: #00ffd0;
  background: #050808;
  z-index: 10;
}
canvas {
  display: block;
  margin: 0 auto;
  touch-action: none;
}
</style>
</head>

<body>
<div id="status">LOADING CYBER GRID…</div>

<script>
/* ================= CORE ================= */

const STATUS = document.getElementById("status");
const WIDTH = 360;
const HEIGHT = 640;

let player, bullets, enemyBullets, enemies, drones, dataItems, powerItems;
let moveDir = 0;
let canShoot = true;
let signal = 100;
let score = 0;
let wave = 1;
let shield = 0;
let gameOver = false;

/* ================= GAME ================= */

new Phaser.Game({
  type: Phaser.AUTO,
  width: WIDTH,
  height: HEIGHT,
  physics: {
    default: 'arcade',
    arcade: { gravity: { y: 0 } }
  },
  scale: {
    mode: Phaser.Scale.FIT,
    autoCenter: Phaser.Scale.CENTER_BOTH
  },
  scene: { preload, create, update }
});

/* ================= PRELOAD ================= */

function preload() {
  this.load.on('progress', p => {
    STATUS.textContent = `LOADING ${Math.floor(p * 100)}%`;
  });

  this.load.on('complete', () => STATUS.style.display = 'none');

  this.load.image('player', 'player.PNG');
  this.load.image('enemy', 'enemy.PNG');
  this.load.image('drone', 'drone.PNG');
  this.load.image('bullet', 'bullet.PNG');
  this.load.image('data', 'data.PNG');
  this.load.image('power', 'power.PNG');
}

/* ================= CREATE ================= */

function create() {
  this.add.rectangle(0, 0, WIDTH, HEIGHT, 0x020a0a).setOrigin(0);

  player = this.physics.add.sprite(WIDTH / 2, HEIGHT - 90, 'player')
    .setScale(0.25)
    .setCollideWorldBounds(true);

  bullets = this.physics.add.group();
  enemyBullets = this.physics.add.group();
  enemies = this.physics.add.group();
  drones = this.physics.add.group();
  dataItems = this.physics.add.group();
  powerItems = this.physics.add.group();

  spawnWave(this);

  // UI
  this.ui = this.add.text(10, 10, '', { fontSize: '12px', color: '#00ffd0' });

  // Touch controls
  const btn = { fontSize: '22px', backgroundColor: '#111', color: '#00ffd0', padding:{x:14,y:6} };
  this.add.text(20, HEIGHT-60, '◀', btn).setInteractive()
    .on('pointerdown',()=>moveDir=-1)
    .on('pointerup',()=>moveDir=0);
  this.add.text(90, HEIGHT-60, '▶', btn).setInteractive()
    .on('pointerdown',()=>moveDir=1)
    .on('pointerup',()=>moveDir=0);
  this.add.text(WIDTH-70, HEIGHT-60, '⦿', btn).setInteractive()
    .on('pointerdown',()=>shoot(this));

  // Collisions
  this.physics.add.overlap(bullets, enemies, killEnemy, null, this);
  this.physics.add.overlap(bullets, drones, killEnemy, null, this);
  this.physics.add.overlap(enemyBullets, player, hitPlayer, null, this);
  this.physics.add.overlap(player, dataItems, collectData, null, this);
  this.physics.add.overlap(player, powerItems, collectPower, null, this);
}

/* ================= UPDATE ================= */

function update() {
  if (gameOver) return;

  player.setVelocityX(moveDir * 240);

  enemies.children.each(e=>{
    if(!e) return;
    e.y += 0.8 + wave*0.2;
    if (Phaser.Math.Between(0,120) === 0) enemyShoot(this, e);
    if(e.y > HEIGHT+40) e.destroy();
  });

  drones.children.each(d=>{
    if(!d) return;
    d.y += 1.6;
    d.x += Math.sin(this.time.now*0.004)*2;
    if(d.y > HEIGHT+40) d.destroy();
  });

  signal -= 0.01;
  shield = Math.max(0, shield - 0.02);

  this.ui.setText(
    `SIGNAL ${Math.floor(signal)}\n`+
    `SHIELD ${Math.floor(shield)}\n`+
    `WAVE ${wave}\n`+
    `SCORE ${score}`
  );

  if (signal <= 0) endGame(this);
}

/* ================= GAMEPLAY ================= */

function shoot(scene){
  if(!canShoot || gameOver) return;
  const b = scene.physics.add.sprite(player.x, player.y-20, 'bullet')
    .setScale(0.15)
    .setVelocityY(-450);
  bullets.add(b);
  canShoot = false;
  scene.time.delayedCall(200, ()=>canShoot=true);
}

function enemyShoot(scene, e){
  const b = scene.physics.add.sprite(e.x, e.y+20, 'bullet')
    .setScale(0.12)
    .setVelocityY(200+wave*20);
  enemyBullets.add(b);
}

function spawnWave(scene){
  for(let i=0;i<3+wave;i++){
    enemies.add(scene.physics.add.sprite(60+i*60, -60, 'enemy').setScale(0.22));
  }
  if(wave % 2 === 0){
    drones.add(scene.physics.add.sprite(WIDTH/2, -120, 'drone').setScale(0.2));
  }
}

function killEnemy(bullet, enemy){
  bullet.destroy();
  enemy.destroy();
  score += 10;
  if(Phaser.Math.Between(0,3)===0)
    dataItems.add(this.physics.add.sprite(enemy.x, enemy.y, 'data').setScale(0.15));
  if(enemies.countActive(true)+drones.countActive(true)===0){
    wave++;
    spawnWave(this);
  }
}

function collectData(player, data){
  data.destroy();
  score += 25;
  signal += 5;
}

function collectPower(player, p){
  p.destroy();
  shield = 50;
}

function hitPlayer(player, bullet){
  bullet.destroy();
  if(shield>0){ shield-=10; return; }
  signal -= 15;
  this.cameras.main.shake(100,0.01);
}

/* ================= END ================= */

function endGame(scene){
  gameOver=true;
  scene.add.rectangle(0,0,WIDTH,HEIGHT,0x000000,0.85).setOrigin(0);
  scene.add.text(WIDTH/2, HEIGHT/2,
    "SIGNAL LOST\nTHE GRID WINS",
    {fontSize:'20px', color:'#ff3355', align:'center'}
  ).setOrigin(0.5);
}
</script>
</body>
</html>
