<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CyberHeist</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<script src="https://cdn.jsdelivr.net/npm/phaser@3.80.0/dist/phaser.min.js"></script>

<style>
html,body{margin:0;padding:0;background:#050808;overflow:hidden}
canvas{display:block;margin:0 auto;touch-action:none}
#overlay{
  position:fixed;inset:0;
  display:flex;align-items:center;justify-content:center;
  font-family:monospace;
  color:#00ffd0;
  background:#050808;
  z-index:10;
}
#warning{
  position:fixed;
  top:45%;
  width:100%;
  text-align:center;
  font-family:monospace;
  font-size:18px;
  color:#ff3355;
  display:none;
}
</style>
</head>

<body>
<div id="overlay">TOUCH TO START</div>
<div id="warning">⚠ SIGNAL CRITICAL ⚠</div>

<script>
/* ================= CORE ================= */

const W=360,H=640;
const overlay=document.getElementById("overlay");
const warning=document.getElementById("warning");

let player, bullets, enemyBullets, enemies, pickups;
let move=0, canShoot=true;
let signal=100, shield=0, score=0;
let invulnerable=false, gameOver=false;

/* ================= GAME ================= */

new Phaser.Game({
  type:Phaser.AUTO,
  width:W,height:H,
  physics:{default:'arcade',arcade:{gravity:{y:0}}},
  scale:{mode:Phaser.Scale.FIT,autoCenter:Phaser.Scale.CENTER_BOTH},
  scene:{preload,create,update}
});

/* ================= PRELOAD ================= */

function preload(){
  this.load.image('player','player.PNG');
  this.load.image('enemy','enemy.PNG');
  this.load.image('bullet','bullet.PNG');
  this.load.image('data','data.PNG');
  this.load.image('power','power.PNG');

  overlay.addEventListener("pointerdown",()=>overlay.style.display="none",{once:true});
}

/* ================= CREATE ================= */

function create(){
  this.add.rectangle(0,0,W,H,0x020a0a).setOrigin(0);

  player=this.physics.add.sprite(W/2,H-100,'player')
    .setScale(0.25)
    .setCollideWorldBounds(true);

  bullets=this.physics.add.group();
  enemyBullets=this.physics.add.group();
  enemies=this.physics.add.group();
  pickups=this.physics.add.group();

  spawnEnemies(this);

  this.ui=this.add.text(10,10,'',{fontSize:'12px',color:'#00ffd0'});

  // Touch controls
  const btn={fontSize:'22px',backgroundColor:'#111',color:'#00ffd0',padding:{x:14,y:6}};
  this.add.text(20,H-60,'◀',btn).setInteractive()
    .on('pointerdown',()=>move=-1)
    .on('pointerup',()=>move=0);
  this.add.text(90,H-60,'▶',btn).setInteractive()
    .on('pointerdown',()=>move=1)
    .on('pointerup',()=>move=0);
  this.add.text(W-70,H-60,'⦿',btn).setInteractive()
    .on('pointerdown',()=>shoot(this));

  // Collisions
  this.physics.add.overlap(bullets,enemies,killEnemy,null,this);
  this.physics.add.overlap(enemyBullets,player,hitPlayer,null,this);
  this.physics.add.overlap(player,pickups,collectPickup,null,this);
}

/* ================= UPDATE ================= */

function update(){
  if(gameOver) return;

  // subtle idle motion
  player.y = H-100 + Math.sin(this.time.now*0.004)*2;
  player.setVelocityX(move*260);

  enemies.children.each(e=>{
    if(!e)return;
    e.y+=1;
    if(Phaser.Math.Between(0,120)==0) enemyShoot(this,e);
    if(e.y>H+40)e.destroy();
  });

  warning.style.display = signal<30 ? "block" : "none";

  this.ui.setText(
    `SIGNAL ${signal}\n`+
    `SHIELD ${shield}\n`+
    `SCORE ${score}`
  );
}

/* ================= GAMEPLAY ================= */

function shoot(scene){
  if(!canShoot||gameOver)return;

  const b=scene.physics.add.sprite(player.x,player.y-30,'bullet')
    .setScale(0.15)
    .setVelocityY(-500)
    .setAngle(-90); // ✅ correct orientation

  bullets.add(b);
  canShoot=false;
  scene.time.delayedCall(200,()=>canShoot=true);
}

function enemyShoot(scene,e){
  const b=scene.physics.add.sprite(e.x,e.y+20,'bullet')
    .setScale(0.12)
    .setVelocityY(220)
    .setAngle(90); // ✅ correct orientation
  enemyBullets.add(b);
}

function spawnEnemies(scene){
  for(let i=0;i<5;i++){
    enemies.add(scene.physics.add.sprite(60+i*60,-80,'enemy').setScale(0.22));
  }
}

function killEnemy(b,e){
  b.destroy();
  e.destroy();
  score+=10;

  if(Phaser.Math.Between(0,2)==0)
    pickups.add(this.physics.add.sprite(e.x,e.y,'data').setScale(0.15));
}

function collectPickup(player,p){
  p.destroy();
  if(p.texture.key==='data') score+=25;
  if(p.texture.key==='power') shield=50;
}

function hitPlayer(player,b){
  if(invulnerable) return;
  b.destroy();

  invulnerable=true;
  player.setTint(0xff0000);
  this.cameras.main.shake(120,0.02);

  if(shield>0){
    shield-=20;
  }else{
    signal-=20;
  }

  this.time.delayedCall(500,()=>{
    invulnerable=false;
    player.clearTint();
  });

  if(signal<=0) endGame(this);
}

/* ================= END ================= */

function endGame(scene){
  gameOver=true;
  scene.add.rectangle(0,0,W,H,0x000000,0.9).setOrigin(0);
  scene.add.text(W/2,H/2,
    "SYSTEM FAILURE\nYOU WERE OVERRUN",
    {fontSize:'18px',color:'#ff3355',align:'center'}
  ).setOrigin(0.5);
}
</script>
</body>
</html>
