<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CyberHeist</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<script src="https://cdn.jsdelivr.net/npm/phaser@3.80.0/dist/phaser.min.js"></script>

<style>
html,body{margin:0;padding:0;background:#020606;overflow:hidden}
canvas{display:block;margin:0 auto;touch-action:none}
#overlay{
  position:fixed;inset:0;
  display:flex;align-items:center;justify-content:center;
  font-family:monospace;
  font-size:22px;
  color:#00ffd0;
  background:#020606;
  z-index:10;
}
#ui{
  position:fixed;top:8px;left:8px;
  font-family:monospace;
  font-size:12px;
  color:#00ffd0;
  z-index:5;
}
</style>
</head>

<body>
<div id="overlay">TOUCH TO START</div>
<div id="ui"></div>

<script>
/* ================= CONFIG ================= */
const W=360,H=640;
let player, playerBullets, enemyBullets;
let enemies, pickups, bossGroup;
let moveDir=0, canShoot=true;
let health=100, shield=0, score=0;
let invuln=false, gameState='PLAY';
let spawnTimer=0, difficulty=1;
let bossHP=0, bossPhase=1;

const overlay=document.getElementById("overlay");
const ui=document.getElementById("ui");

/* ================= GAME ================= */
new Phaser.Game({
  type:Phaser.AUTO,
  width:W,height:H,
  physics:{default:'arcade',arcade:{gravity:{y:0}}},
  scale:{mode:Phaser.Scale.FIT,autoCenter:Phaser.Scale.CENTER_BOTH},
  scene:{preload,create,update}
});

/* ================= PRELOAD ================= */
function preload(){
  this.load.image('player','player.PNG');
  this.load.image('enemy','enemy.PNG');
  this.load.image('bullet','bullet.PNG');
  this.load.image('data','data.PNG');
  this.load.image('power','power.PNG');
  this.load.image('boss','boss.PNG');

  overlay.addEventListener("pointerdown",()=>{
    overlay.style.display="none";
  },{once:true});
}

/* ================= CREATE ================= */
function create(){
  this.add.rectangle(0,0,W,H,0x020a0a).setOrigin(0);

  player=this.physics.add.sprite(W/2,H-90,'player')
    .setScale(0.25)
    .setCollideWorldBounds(true);

  playerBullets=this.physics.add.group();
  enemyBullets=this.physics.add.group();
  enemies=this.physics.add.group();
  pickups=this.physics.add.group();
  bossGroup=this.physics.add.group();

  // Touch controls
  const style={fontSize:'20px',backgroundColor:'#111',color:'#00ffd0',padding:{x:14,y:6}};
  this.add.text(20,H-60,'◀',style).setInteractive()
    .on('pointerdown',()=>moveDir=-1)
    .on('pointerup',()=>moveDir=0);
  this.add.text(90,H-60,'▶',style).setInteractive()
    .on('pointerdown',()=>moveDir=1)
    .on('pointerup',()=>moveDir=0);
  this.add.text(W-70,H-60,'⦿',style).setInteractive()
    .on('pointerdown',()=>shoot(this));

  // Collisions
  this.physics.add.overlap(playerBullets,enemies,enemyHit,null,this);
  this.physics.add.overlap(playerBullets,bossGroup,bossHit,null,this);
  this.physics.add.overlap(enemyBullets,player,playerHit,null,this);
  this.physics.add.overlap(player,pickups,pickup,null,this);
}

/* ================= UPDATE ================= */
function update(time){
  if(gameState==='GAMEOVER')return;

  // Player motion
  player.setVelocityX(moveDir*260);
  player.y = H-90 + Math.sin(time*0.004)*3;

  if(gameState==='PLAY'){
    spawnTimer++;
    if(spawnTimer>90-(difficulty*6)){
      spawnTimer=0;
      spawnEnemy(this);
    }
    if(score>=500){
      startBoss(this);
    }
  }

  // Enemy behavior
  enemies.children.each(e=>{
    if(!e)return;
    e.y+=1.2;
    e.x+=Math.sin(time*0.003+e.y)*0.7;
    if(Phaser.Math.Between(0,130)==0)
      enemyShoot(this,e);
    if(e.y>H+40)e.destroy();
  });

  // Boss behavior
  bossGroup.children.each(b=>{
    if(!b)return;
    b.x=W/2+Math.sin(time*0.002)*90;

    if(time% (bossPhase===1?80:40) < 2){
      bossShoot(this,b);
    }
  });

  cleanup();

  ui.innerText=
    `SIGNAL ${health}\n`+
    `SHIELD ${shield}\n`+
    `SCORE ${score}`+
    (gameState==='BOSS'?`\nBOSS ${bossHP}`:'');
}

/* ================= ACTIONS ================= */
function shoot(scene){
  if(!canShoot||gameState==='GAMEOVER')return;

  const b=scene.physics.add.sprite(player.x,player.y-28,'bullet')
    .setScale(0.15)
    .setVelocityY(-540)
    .setAngle(-90);

  playerBullets.add(b);
  canShoot=false;
  scene.time.delayedCall(160,()=>canShoot=true);
}

function enemyShoot(scene,e){
  const b=scene.physics.add.sprite(e.x,e.y+18,'bullet')
    .setScale(0.12)
    .setVelocityY(260)
    .setAngle(90);
  enemyBullets.add(b);
}

function bossShoot(scene,b){
  for(let i=-1;i<=1;i++){
    const shot=scene.physics.add.sprite(b.x+i*30,b.y+40,'bullet')
      .setScale(0.18)
      .setVelocity(i*60,280)
      .setAngle(90);
    enemyBullets.add(shot);
  }
}

function spawnEnemy(scene){
  enemies.add(
    scene.physics.add.sprite(
      Phaser.Math.Between(40,W-40),
      -40,'enemy'
    ).setScale(0.22)
  );
}

/* ================= BOSS ================= */
function startBoss(scene){
  gameState='BOSS';
  enemies.clear(true,true);
  bossGroup.clear(true,true);

  const boss=scene.physics.add.sprite(W/2,-140,'boss')
    .setScale(0.35);
  bossGroup.add(boss);

  bossHP=400;
  bossPhase=1;

  scene.tweens.add({
    targets:boss,y:140,duration:1500,ease:'Sine.easeOut'
  });
}

function bossHit(bullet,boss){
  bullet.destroy();
  bossHP-=10;

  boss.setTint(0xff4444);
  setTimeout(()=>boss.clearTint(),80);

  if(bossHP<200) bossPhase=2;

  if(bossHP<=0){
    boss.destroy();
    bossGroup.clear(true,true);
    gameState='PLAY';
    score+=500;
    difficulty++;
  }
}

/* ================= COLLISIONS ================= */
function enemyHit(b,e){
  b.destroy();
  e.destroy();
  score+=10;
}

function pickup(player,p){
  p.destroy();
  if(p.texture.key==='data')score+=25;
  if(p.texture.key==='power')shield=50;
}

function playerHit(player,b){
  if(invuln)return;
  b.destroy();

  invuln=true;
  player.setTint(0xff3333);

  if(shield>0)shield-=20;
  else health-=20;

  setTimeout(()=>{
    invuln=false;
    player.clearTint();
  },400);

  if(health<=0) endGame(this);
}

/* ================= CLEANUP ================= */
function cleanup(){
  playerBullets.children.each(b=>{if(b && b.y<-20)b.destroy();});
  enemyBullets.children.each(b=>{if(b && b.y>H+20)b.destroy();});
}

/* ================= END ================= */
function endGame(scene){
  gameState='GAMEOVER';
  scene.add.rectangle(0,0,W,H,0x000000,0.9).setOrigin(0);
  scene.add.text(W/2,H/2,
    "SYSTEM COLLAPSE\nFINAL SCORE "+score,
    {fontSize:'18px',color:'#ff3355',align:'center'}
  ).setOrigin(0.5);
}
</script>
</body>
</html>
