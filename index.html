<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CyberHeist</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<script src="https://cdn.jsdelivr.net/npm/phaser@3.80.0/dist/phaser.min.js"></script>

<style>
html,body{margin:0;padding:0;background:#030707;overflow:hidden}
canvas{display:block;margin:0 auto;touch-action:none}
#overlay{
  position:fixed;inset:0;
  display:flex;align-items:center;justify-content:center;
  font-family:monospace;
  font-size:22px;
  color:#00ffd0;
  background:#030707;
  z-index:10;
}
#ui{
  position:fixed;top:8px;left:8px;
  font-family:monospace;
  font-size:12px;
  color:#00ffd0;
  z-index:5;
}
</style>
</head>

<body>
<div id="overlay">TOUCH TO START</div>
<div id="ui"></div>

<script>
/* ================= CONFIG ================= */
const W=360,H=640;
let player, bullets, enemyBullets, enemies, pickups, boss;
let moveDir=0, canShoot=true;
let health=100, shield=0, score=0;
let invuln=false, gameOver=false;
let spawnTimer=0, difficulty=1;
let bossActive=false, bossHealth=0;

const overlay=document.getElementById("overlay");
const ui=document.getElementById("ui");

/* ================= GAME ================= */
new Phaser.Game({
  type:Phaser.AUTO,
  width:W,height:H,
  physics:{default:'arcade',arcade:{gravity:{y:0}}},
  scale:{mode:Phaser.Scale.FIT,autoCenter:Phaser.Scale.CENTER_BOTH},
  scene:{preload,create,update}
});

/* ================= PRELOAD ================= */
function preload(){
  this.load.image('player','player.PNG');
  this.load.image('enemy','enemy.PNG');
  this.load.image('bullet','bullet.PNG');
  this.load.image('data','data.PNG');
  this.load.image('power','power.PNG');
  this.load.image('boss','boss.PNG');

  overlay.addEventListener("pointerdown",()=>{
    overlay.style.display="none";
  },{once:true});
}

/* ================= CREATE ================= */
function create(){
  this.add.rectangle(0,0,W,H,0x020a0a).setOrigin(0);

  player=this.physics.add.sprite(W/2,H-100,'player')
    .setScale(0.25)
    .setCollideWorldBounds(true);

  bullets=this.physics.add.group();
  enemyBullets=this.physics.add.group();
  enemies=this.physics.add.group();
  pickups=this.physics.add.group();

  // Touch controls
  const style={fontSize:'20px',backgroundColor:'#111',color:'#00ffd0',padding:{x:14,y:6}};
  this.add.text(20,H-60,'◀',style).setInteractive()
    .on('pointerdown',()=>moveDir=-1)
    .on('pointerup',()=>moveDir=0);
  this.add.text(90,H-60,'▶',style).setInteractive()
    .on('pointerdown',()=>moveDir=1)
    .on('pointerup',()=>moveDir=0);
  this.add.text(W-70,H-60,'⦿',style).setInteractive()
    .on('pointerdown',()=>shoot(this));

  // Collisions
  this.physics.add.overlap(bullets,enemies,enemyHit,null,this);
  this.physics.add.overlap(bullets,()=>bossActive?boss:null,bossHit,null,this);
  this.physics.add.overlap(enemyBullets,player,playerHit,null,this);
  this.physics.add.overlap(player,pickups,pickup,null,this);
}

/* ================= UPDATE ================= */
function update(time){
  if(gameOver)return;

  player.setVelocityX(moveDir*260);
  player.y = H-100 + Math.sin(time*0.004)*3;

  // Spawn logic
  if(!bossActive){
    spawnTimer++;
    if(spawnTimer>90-(difficulty*5)){
      spawnTimer=0;
      spawnEnemy(this);
    }
  }

  // Trigger boss
  if(score>=500 && !bossActive){
    spawnBoss(this);
  }

  // Enemy behavior
  enemies.children.each(e=>{
    if(!e)return;
    e.y+=1.2;
    e.x+=Math.sin(time*0.003+e.y)*0.6;
    if(Phaser.Math.Between(0,140)==0)
      enemyShoot(this,e);
    if(e.y>H+40)e.destroy();
  });

  // Boss behavior
  if(bossActive && boss){
    boss.x = W/2 + Math.sin(time*0.002)*80;
    if(Phaser.Math.Between(0,50)==0)
      enemyShoot(this,boss);
  }

  cleanup();

  ui.innerText=
    `SIGNAL ${health}\n`+
    `SHIELD ${shield}\n`+
    `SCORE ${score}`+
    (bossActive?`\nBOSS ${bossHealth}`:'');
}

/* ================= ACTIONS ================= */
function shoot(scene){
  if(!canShoot||gameOver)return;

  const b=scene.physics.add.sprite(player.x,player.y-28,'bullet')
    .setScale(0.15)
    .setVelocityY(-520)
    .setAngle(-90);

  bullets.add(b);
  canShoot=false;
  scene.time.delayedCall(180,()=>canShoot=true);
}

function enemyShoot(scene,e){
  const b=scene.physics.add.sprite(e.x,e.y+20,'bullet')
    .setScale(e===boss?0.18:0.12)
    .setVelocityY(260)
    .setAngle(90);
  enemyBullets.add(b);
}

function spawnEnemy(scene){
  enemies.add(
    scene.physics.add.sprite(
      Phaser.Math.Between(40,W-40),
      -40,'enemy'
    ).setScale(0.22)
  );
}

/* ================= BOSS ================= */
function spawnBoss(scene){
  bossActive=true;
  enemies.clear(true,true);

  boss=scene.physics.add.sprite(W/2,-120,'boss')
    .setScale(0.35);

  bossHealth=300;
  scene.tweens.add({
    targets:boss,y:140,duration:1500,ease:'Sine.easeOut'
  });
}

function bossHit(b){
  b.destroy();
  bossHealth-=10;
  boss.setTint(0xff4444);
  setTimeout(()=>boss.clearTint(),80);

  if(bossHealth<=0){
    boss.destroy();
    bossActive=false;
    score+=500;
    difficulty++;
  }
}

/* ================= COLLISIONS ================= */
function enemyHit(b,e){
  b.destroy();
  e.destroy();
  score+=10;
}

function pickup(player,p){
  p.destroy();
  if(p.texture.key==='data')score+=25;
  if(p.texture.key==='power')shield=50;
}

function playerHit(player,b){
  if(invuln)return;
  b.destroy();

  invuln=true;
  player.setTint(0xff3333);

  if(shield>0)shield-=20;
  else health-=20;

  setTimeout(()=>{
    invuln=false;
    player.clearTint();
  },400);

  if(health<=0) endGame(this);
}

function cleanup(){
  bullets.children.each(b=>{if(b && b.y<-20)b.destroy();});
  enemyBullets.children.each(b=>{if(b && b.y>H+20)b.destroy();});
}

/* ================= END ================= */
function endGame(scene){
  gameOver=true;
  scene.add.rectangle(0,0,W,H,0x000000,0.9).setOrigin(0);
  scene.add.text(W/2,H/2,
    "SYSTEM COLLAPSE\nFINAL SCORE "+score,
    {fontSize:'18px',color:'#ff3355',align:'center'}
  ).setOrigin(0.5);
}
</script>
</body>
</html>
