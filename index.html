<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CyberHeist: Signal Escape</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<script src="https://cdn.jsdelivr.net/npm/phaser@3.80.0/dist/phaser.min.js"></script>
<style>
html,body{margin:0;padding:0;background:#010808;overflow:hidden;}
canvas{display:block;margin:0 auto;touch-action:none;}
.overlay{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:monospace;color:#00ffd0;background:rgba(1,8,8,0.95);text-align:center;padding:20px;z-index:10;}
.hidden{display:none !important;}
.button{margin-top:20px;padding:8px 14px;border:1px solid #00ffd0;color:#00ffd0;cursor:pointer;}
.button:hover{background:#00ffd0;color:#000;}
</style>
</head>
<body>

<div id="startOverlay" class="overlay">LOADING…</div>
<div id="endOverlay" class="overlay hidden"></div>

<script>
const WIDTH=360,HEIGHT=640;
let mainScene;
let canShoot=true;

const game = new Phaser.Game({
  type: Phaser.AUTO,
  width: WIDTH,
  height: HEIGHT,
  physics:{default:'arcade',arcade:{gravity:{y:0},debug:false}},
  scale:{mode:Phaser.Scale.FIT,autoCenter:Phaser.Scale.CENTER_BOTH},
  scene:{preload,create,update}
});

/* ========== PRELOAD ========== */
function preload(){
  const overlay=document.getElementById("startOverlay");
  this.load.on('progress',p=>{overlay.textContent="LOADING "+Math.floor(p*100)+"%";});
  this.load.on('complete',()=>{
    overlay.innerHTML="TOUCH TO START";
    function startGame(){
      overlay.classList.add("hidden");
      overlay.removeEventListener("pointerdown",startGame);
      overlay.removeEventListener("touchstart",startGame);
      overlay.removeEventListener("click",startGame);
      mainScene.paused=false;
      spawnWave(mainScene);
    }
    overlay.addEventListener("pointerdown",startGame,{once:true});
    overlay.addEventListener("touchstart",startGame,{once:true});
    overlay.addEventListener("click",startGame,{once:true});
  });

  this.load.image('player','player.PNG');
  this.load.image('enemy','enemy.PNG');
  this.load.image('drone','drone.PNG');
  this.load.image('boss','boss.PNG');
  this.load.image('bullet','bullet.PNG');
  this.load.image('data','data.PNG');
  this.load.image('power','power.PNG');
}

/* ========== CREATE ========== */
function create(){
  mainScene=this;
  this.paused=true;
  this.gameOver=false;

  this.add.rectangle(0,0,WIDTH,HEIGHT,0x020a0a).setOrigin(0);

  this.player=this.physics.add.sprite(WIDTH/2,HEIGHT-90,'player').setScale(0.25).setCollideWorldBounds(true);

  this.bullets=this.physics.add.group();
  this.eBullets=this.physics.add.group();
  this.enemies=this.physics.add.group();
  this.drones=this.physics.add.group();
  this.pickups=this.physics.add.group();

  this.stateData={signal:100,shield:0,score:0,fireRate:180,speed:240,wave:1,bossHP:0,bossActive:false};

  this.uiText=this.add.text(10,10,"",{fontSize:"12px",color:"#00ffd0"});

  // TOUCH CONTROLS
  const style={fontSize:'22px',backgroundColor:'#111',color:'#00ffd0',padding:{x:14,y:6}};
  this.add.text(20,HEIGHT-60,'◀',style).setInteractive().on('pointerdown',()=>this.m=-1).on('pointerup',()=>this.m=0).on('pointerout',()=>this.m=0);
  this.add.text(90,HEIGHT-60,'▶',style).setInteractive().on('pointerdown',()=>this.m=1).on('pointerup',()=>this.m=0).on('pointerout',()=>this.m=0);
  this.add.text(WIDTH-70,HEIGHT-60,'⦿',style).setInteractive().on('pointerdown',()=>shoot(this));

  // COLLISIONS
  this.physics.add.overlap(this.bullets,this.enemies,killEnemy,null,this);
  this.physics.add.overlap(this.bullets,this.drones,killEnemy,null,this);
  this.physics.add.overlap(this.eBullets,this.player,hitPlayer,null,this);
  this.physics.add.overlap(this.player,this.pickups,collectPickup,null,this);
}

/* ========== UPDATE ========== */
function update(){
  if(mainScene.paused||mainScene.gameOver) return;
  const st=mainScene.stateData;
  mainScene.player.setVelocityX(mainScene.m*st.speed);

  mainScene.enemies.children.each(enemy=>{
    if(!enemy)return;
    enemy.y+=0.8+st.wave*0.2;
    if(Phaser.Math.Between(0,120)===0) enemyShoot(mainScene,enemy);
    if(enemy.y>HEIGHT+40) enemy.destroy();
  });

  mainScene.drones.children.each(d=>{
    if(!d)return;
    d.y+=1.6;
    d.x+=Math.sin(mainScene.time.now*0.004)*2;
  });

  mainScene.uiText.setText(`SIGNAL ${st.signal}\nSHIELD ${st.shield}\nWAVE ${st.wave}\nSCORE ${st.score}`);

  if(st.signal<=0) endGame(mainScene,"Signal depleted");
}

/* ========== GAME FUNCTIONS ========== */
function shoot(scene){
  const st=scene.stateData;
  if(!canShoot||scene.paused||scene.gameOver) return;
  const b=scene.physics.add.sprite(scene.player.x,scene.player.y-20,'bullet').setScale(0.15).setVelocityY(-450).setAngle(-90);
  scene.bullets.add(b);
  canShoot=false;
  scene.time.delayedCall(st.fireRate,()=>canShoot=true);
}

function enemyShoot(scene,enemy){
  const b=scene.physics.add.sprite(enemy.x,enemy.y+20,'bullet').setScale(0.12).setVelocityY(200+scene.stateData.wave*20).setAngle(90);
  scene.eBullets.add(b);
}

function spawnWave(scene){
  const st=scene.stateData;
  if(st.wave===5&&!st.bossActive){
    st.bossActive=true;
    scene.boss=scene.physics.add.sprite(WIDTH/2,-200,'boss').setScale(0.4);
    st.bossHP=200;
    return;
  }
  for(let i=0;i<3+st.wave;i++){
    scene.enemies.add(scene.physics.add.sprite(60+i*60,-60,'enemy').setScale(0.22));
  }
  if(st.wave%2===0) scene.drones.add(scene.physics.add.sprite(WIDTH/2,-120,'drone').setScale(0.2));
}

function killEnemy(bullet,enemy){
  bullet.destroy(); enemy.destroy();
  mainScene.stateData.score+=10;
  dropPickup(mainScene,enemy.x,enemy.y);
  if(mainScene.enemies.countActive()+mainScene.drones.countActive()===0){
    mainScene.stateData.wave++;
    spawnWave(mainScene);
  }
}

function hitPlayer(player,bullet){
  bullet.destroy();
  const st=mainScene.stateData;
  if(st.shield>0){st.shield-=10; return;}
  st.signal-=15;
  mainScene.cameras.main.flash(100,255,0,0);
  mainScene.cameras.main.shake(80,0.02);
  if(st.signal<=0) endGame(mainScene,"You were destroyed");
}

function dropPickup(scene,x,y){
  const n=Phaser.Math.Between(0,5);
  if(n<1) scene.pickups.add(scene.physics.add.sprite(x,y,'data').setScale(0.15));
  if(n===2) scene.pickups.add(scene.physics.add.sprite(x,y,'power').setScale(0.15));
}

function collectPickup(player,p){
  p.destroy();
  const st=mainScene.stateData;
  if(p.texture.key==='data') st.score+=50;
  if(p.texture.key==='power') st.shield=50;
}

function endGame(scene,reason){
  scene.gameOver=true;
  const endDiv=document.getElementById("endOverlay");
  endDiv.innerHTML=`${reason}<br><div class="button" onclick="location.reload()">RESTART</div>`;
  endDiv.classList.remove("hidden");
}
</script>
</body>
</html>
